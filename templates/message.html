<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î©îÏãúÏßÄ ÏûëÏÑ± - ÎÇòÏù∏Ìä∏Î¶¨ Ìò∏ÌÖî</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .room-info {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-details p {
            margin: 2px 0;
            font-size: 16px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-dot.connected {
            background-color: #4caf50;
        }

        .status-dot.connecting {
            background-color: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-mode-selector {
            padding: 15px 20px;
            background-color: #fff3cd;
            border-bottom: 1px solid #e1e1e1;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background-color: white;
            color: #333;
            border: 1px solid #e1e1e1;
        }

        .message.staff {
            background-color: #e8f5e8;
            color: #333;
            border: 1px solid #c8e6c9;
            border-left: 4px solid #4caf50;
        }

        .message.system {
            background-color: #e9ecef;
            color: #666;
            text-align: center;
            font-size: 14px;
            margin: 10px auto;
            max-width: 100%;
        }

        .message-header {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .message.staff .message-header {
            color: #2e7d32;
            font-weight: bold;
        }

        .staff-indicator {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        .message-input-container {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e1e1e1;
        }

        .message-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            min-width: 100px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-staff {
            background-color: #28a745;
            color: white;
            min-width: 120px;
        }

        .btn-staff:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #666;
            font-size: 14px;
            display: none;
        }

        .typing-indicator.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .quick-action {
            background-color: #f8f9fa;
            border: 1px solid #e1e1e1;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background-color: #e9ecef;
            border-color: #667eea;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }

            .room-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .mode-buttons {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }

            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè® ÎÇòÏù∏Ìä∏Î¶¨ Ìò∏ÌÖî</h1>
            <p>AI Î©îÏãúÏßÄ Ïª®ÏãúÏñ¥ÏßÄ</p>
        </div>

        <div class="room-info">
            <div class="room-details">
                <p id="roomInfo"><strong>Í∞ùÏã§:</strong> <span id="roomNumber">-</span></p>
                <p id="languageInfo"><strong>Ïñ∏Ïñ¥:</strong> <span id="selectedLanguage">-</span></p>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Ïó∞Í≤∞ Ï§ë...</span>
            </div>
        </div>

        <div class="chat-mode-selector" id="chatModeSelector">
            <p><strong>üí° ÏÑúÎπÑÏä§ Î™®ÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</strong></p>
            <div class="mode-buttons">
                <button class="mode-btn active" id="aiMode" onclick="setMode('ai')">
                    ü§ñ AI ÏûêÎèô ÏùëÎãµ
                </button>
                <button class="mode-btn" id="staffMode" onclick="setMode('staff')">
                    üë®‚Äçüíº ÏßÅÏõêÍ≥º Ï±ÑÌåÖ
                </button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message system">
                ÏïàÎÖïÌïòÏÑ∏Ïöî! Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî? ü§ñ<br>
                <small>Í∞ÑÎã®Ìïú ÏßàÎ¨∏ÏùÄ AIÍ∞Ä, Î≥µÏû°Ìïú Î¨∏ÏùòÎäî ÏßÅÏõêÏù¥ ÎèÑÏõÄÎìúÎ¶ΩÎãàÎã§.</small>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            AIÍ∞Ä ÏùëÎãµÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...
        </div>

        <div class="loading" id="loadingIndicator">
            Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...
        </div>

        <div class="message-input-container">
            <div class="quick-actions">
                <button class="quick-action" onclick="insertQuickMessage('WiFi ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≠îÍ∞ÄÏöî?')">WiFi ÎπÑÎ∞ÄÎ≤àÌò∏</button>
                <button class="quick-action" onclick="insertQuickMessage('Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏãúÍ∞ÑÏù¥ Ïñ∏Ï†úÏù∏Í∞ÄÏöî?')">Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏãúÍ∞Ñ</button>
                <button class="quick-action" onclick="insertQuickMessage('Ï°∞ÏãùÏùÄ Î™á ÏãúÎ∂ÄÌÑ∞Ïù∏Í∞ÄÏöî?')">Ï°∞Ïãù ÏãúÍ∞Ñ</button>
                <button class="quick-action" onclick="insertQuickMessage('ÏàòÏòÅÏû• Ïù¥Ïö© ÏãúÍ∞ÑÏùÑ ÏïåÍ≥† Ïã∂Ïñ¥Ïöî')">ÏàòÏòÅÏû• ÏãúÍ∞Ñ</button>
                <button class="quick-action" onclick="insertQuickMessage('Ï£ºÏ∞®Ïû•ÏùÄ Ïñ¥ÎîîÏóê ÏûàÎÇòÏöî?')">Ï£ºÏ∞®Ïû• ÏúÑÏπò</button>
                <button class="quick-action" onclick="insertQuickMessage('ÌÉÄÏò¨ÏùÑ Îçî Ï£ºÏã§ Ïàò ÏûàÎÇòÏöî?')">ÌÉÄÏò¨ ÏöîÏ≤≠</button>
            </div>

            <textarea 
                id="messageInput" 
                class="message-input" 
                placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                rows="3"
            ></textarea>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    Îí§Î°úÍ∞ÄÍ∏∞
                </button>
                <button type="button" class="btn btn-primary" id="sendButton" disabled>
                    Î©îÏãúÏßÄ Ï†ÑÏÜ°
                </button>
                <button type="button" class="btn btn-staff" id="requestStaffButton" onclick="requestStaff()" style="display: none;">
                    ÏßÅÏõê Ïó∞Í≤∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room');
        const selectedLanguage = urlParams.get('lang');

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let socket;
        let currentMode = 'ai'; // 'ai' ÎòêÎäî 'staff'
        let currentRoomId = null;
        let isConnectedToStaff = false;

        // DOM ÏöîÏÜå
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatContainer = document.getElementById('chatContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const typingIndicator = document.getElementById('typingIndicator');
        const requestStaffButton = document.getElementById('requestStaffButton');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Ïñ∏Ïñ¥ ÌëúÏãú ÌÖçÏä§Ìä∏
        const languageNames = {
            'ko': 'ÌïúÍµ≠Ïñ¥ üá∞üá∑',
            'en': 'English üá∫üá∏',
            'ja': 'Êó•Êú¨Ë™û üáØüáµ',
            'zh': '‰∏≠Êñá üá®üá≥'
        };

        // Îã§Íµ≠Ïñ¥ ÌÖçÏä§Ìä∏
        const translations = {
            'ko': {
                messagePlaceholder: 'Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...',
                backButton: 'Îí§Î°úÍ∞ÄÍ∏∞',
                sendButton: 'Î©îÏãúÏßÄ Ï†ÑÏÜ°',
                staffButton: 'ÏßÅÏõê Ïó∞Í≤∞',
                aiThinking: 'AIÍ∞Ä ÏùëÎãµÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...',
                staffConnecting: 'ÏßÅÏõê Ïó∞Í≤∞ÏùÑ ÏöîÏ≤≠ÌñàÏäµÎãàÎã§...',
                staffConnected: 'ÏßÅÏõêÍ≥º Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§!',
                connectionLost: 'Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. Ïû¨Ïó∞Í≤∞ Ï§ë...'
            },
            'en': {
                messagePlaceholder: 'Enter your message...',
                backButton: 'Back',
                sendButton: 'Send Message',
                staffButton: 'Connect Staff',
                aiThinking: 'AI is generating response...',
                staffConnecting: 'Requesting staff connection...',
                staffConnected: 'Connected to staff!',
                connectionLost: 'Connection lost. Reconnecting...'
            },
            'ja': {
                messagePlaceholder: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...',
                backButton: 'Êàª„Çã',
                sendButton: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°',
                staffButton: '„Çπ„Çø„ÉÉ„ÉïÊé•Á∂ö',
                aiThinking: 'AI„ÅåËøîÁ≠î„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...',
                staffConnecting: '„Çπ„Çø„ÉÉ„ÉïÊé•Á∂ö„ÇíË¶ÅÊ±Ç„Åó„Åæ„Åó„Åü...',
                staffConnected: '„Çπ„Çø„ÉÉ„Éï„Å®Êé•Á∂ö„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
                connectionLost: 'Êé•Á∂ö„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇÂÜçÊé•Á∂ö‰∏≠...'
            },
            'zh': {
                messagePlaceholder: 'ËØ∑ËæìÂÖ•‰ø°ÊÅØ...',
                backButton: 'ËøîÂõû',
                sendButton: 'ÂèëÈÄÅ‰ø°ÊÅØ',
                staffButton: 'ËøûÊé•ÂëòÂ∑•',
                aiThinking: 'AIÊ≠£Âú®ÁîüÊàêÂõûÂ§ç...',
                staffConnecting: 'Â∑≤ËØ∑Ê±ÇÂëòÂ∑•ËøûÊé•...',
                staffConnected: 'Â∑≤‰∏éÂëòÂ∑•ËøûÊé•ÔºÅ',
                connectionLost: 'ËøûÊé•Êñ≠ÂºÄ„ÄÇÈáçÊñ∞ËøûÊé•‰∏≠...'
            }
        };

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        function initializePage() {
            // ÌïÑÏàò ÏöîÏÜå Ï°¥Ïû¨ ÌôïÏù∏
            const roomNumberElement = document.getElementById('roomNumber');
            const selectedLanguageElement = document.getElementById('selectedLanguage');
            
            if (!roomNumberElement || !selectedLanguageElement) {
                console.error('Required HTML elements not found');
                return;
            }
            
            roomNumberElement.textContent = roomNumber || '?';
            selectedLanguageElement.textContent = languageNames[selectedLanguage] || 'Unknown';
            
            // Ïñ∏Ïñ¥Î≥Ñ UI ÌÖçÏä§Ìä∏ Ï†ÅÏö©
            const texts = translations[selectedLanguage] || translations['ko'];

            // Í∏∞Î≥∏ UI ÏöîÏÜåÎì§ ÏïàÏ†ÑÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            if (messageInput) {
                messageInput.placeholder = texts.messagePlaceholder;
            }
            if (sendButton) {
                sendButton.textContent = texts.sendButton;
            }
            if (requestStaffButton) {
                requestStaffButton.textContent = texts.staffButton;
            }
            
            const backBtn = document.querySelector('.btn-secondary');
            if (backBtn) {
                backBtn.textContent = texts.backButton;
            }

            // Î™®Îìú Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateModeButtonTexts();

            // Îπ†Î•∏ Ïï°ÏÖò Î≤ÑÌäºÎì§ Ïñ∏Ïñ¥Î≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickActionButtons();

            // Socket.IO Ïó∞Í≤∞
            connectSocket();
        }

        // üîß ÏàòÏ†ïÎêú Î™®Îìú Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateModeButtonTexts() {
            const modeTexts = {
                'ko': {
                    aiMode: 'ü§ñ AI ÏûêÎèô ÏùëÎãµ',
                    staffMode: 'üë®‚Äçüíº ÏßÅÏõêÍ≥º Ï±ÑÌåÖ'
                },
                'en': {
                    aiMode: 'ü§ñ AI Auto Response',
                    staffMode: 'üë®‚Äçüíº Chat with Staff'
                },
                'ja': {
                    aiMode: 'ü§ñ AIËá™ÂãïÂøúÁ≠î',
                    staffMode: 'üë®‚Äçüíº „Çπ„Çø„ÉÉ„Éï„Å®„ÉÅ„É£„ÉÉ„Éà'
                },
                'zh': {
                    aiMode: 'ü§ñ AIËá™Âä®ÂõûÂ§ç',
                    staffMode: 'üë®‚Äçüíº ‰∏éÂëòÂ∑•ËÅäÂ§©'
                }
            };
            
            const currentTexts = modeTexts[selectedLanguage] || modeTexts['ko'];
            
            // üîß ÏïàÏ†ÑÌïú ÏöîÏÜå Ï†ëÍ∑º (Ïò§ÌÉÄ ÏàòÏ†ï: aimode ‚Üí aiMode)
            const aiModeBtn = document.getElementById('aiMode');
            const staffModeBtn = document.getElementById('staffMode');
            
            if (aiModeBtn) {
                aiModeBtn.innerHTML = currentTexts.aiMode;
            }
            if (staffModeBtn) {
                staffModeBtn.innerHTML = currentTexts.staffMode;
            }
        }

        // Îπ†Î•∏ Ïï°ÏÖò Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateQuickActionButtons() {
            const quickActions = {
                'ko': [
                    'WiFi ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≠îÍ∞ÄÏöî?',
                    'Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏãúÍ∞ÑÏù¥ Ïñ∏Ï†úÏù∏Í∞ÄÏöî?',
                    'Ï°∞ÏãùÏùÄ Î™á ÏãúÎ∂ÄÌÑ∞Ïù∏Í∞ÄÏöî?',
                    'ÏàòÏòÅÏû• Ïù¥Ïö© ÏãúÍ∞ÑÏùÑ ÏïåÍ≥† Ïã∂Ïñ¥Ïöî',
                    'Ï£ºÏ∞®Ïû•ÏùÄ Ïñ¥ÎîîÏóê ÏûàÎÇòÏöî?',
                    'ÌÉÄÏò¨ÏùÑ Îçî Ï£ºÏã§ Ïàò ÏûàÎÇòÏöî?'
                ],
                'en': [
                    'What is the WiFi password?',
                    'What time is check-out?',
                    'What time is breakfast?',
                    'What are the pool hours?',
                    'Where is the parking?',
                    'Can I get more towels?'
                ],
                'ja': [
                    'WiFi„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    '„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÊôÇÈñì„ÅØ‰ΩïÊôÇ„Åß„Åô„ÅãÔºü',
                    'ÊúùÈ£ü„ÅØ‰ΩïÊôÇ„Åã„Çâ„Åß„Åô„ÅãÔºü',
                    '„Éó„Éº„É´„ÅÆÂà©Áî®ÊôÇÈñì„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
                    'ÈßêËªäÂ†¥„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü',
                    '„Çø„Ç™„É´„Çí„ÇÇ„Å£„Å®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü'
                ],
                'zh': [
                    'WiFiÂØÜÁ†ÅÊòØ‰ªÄ‰πàÔºü',
                    'ÈÄÄÊàøÊó∂Èó¥ÊòØÂá†ÁÇπÔºü',
                    'Êó©È§êÂá†ÁÇπÂºÄÂßãÔºü',
                    'Ê∏∏Ê≥≥Ê±†ÂºÄÊîæÊó∂Èó¥Ôºü',
                    'ÂÅúËΩ¶Âú∫Âú®Âì™ÈáåÔºü',
                    'ÂèØ‰ª•ÂÜçÁªô‰∏Ä‰∫õÊØõÂ∑æÂêóÔºü'
                ]
            };
            
            const actions = quickActions[selectedLanguage] || quickActions['ko'];
            const quickActionElements = document.querySelectorAll('.quick-action');

            quickActionElements.forEach((element, index) => {
                if (actions[index]) {
                    element.textContent = actions[index];
                    element.onclick = () => insertQuickMessage(actions[index]);
                }
            });
        }

        // Socket.IO Ïó∞Í≤∞
        function connectSocket() {
            try {
                socket = io();

                socket.on('connect', () => {
                    console.log('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
                    updateConnectionStatus('connected');
                });

                socket.on('disconnect', () => {
                    console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.');
                    updateConnectionStatus('disconnected');
                });

                // Î©îÏãúÏßÄ ÏàòÏã†
                socket.on('receive_message', (data) => {
                    console.log('Î©îÏãúÏßÄ ÏàòÏã†:', data);
                    displayMessage(data);
                });

                // ÏßÅÏõê Ï∞∏Ïó¨ ÏïåÎ¶º
                socket.on('staff_joined', (data) => {
                    console.log('ÏßÅÏõê Ï∞∏Ïó¨:', data);
                    isConnectedToStaff = true;
                    addMessage(data.message, 'system');
                    addStaffIndicator();
                    updateConnectionStatus('staff_connected');
                });

                // ÏãúÏä§ÌÖú Î©îÏãúÏßÄ
                socket.on('system_message', (data) => {
                    addMessage(data.message, 'system');
                    
                    // room_idÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï†ÄÏû•
                    if (data.room_id) {
                        currentRoomId = data.room_id;
                        console.log('Ï±ÑÌåÖÎ∞© ID ÏÑ§Ï†ï:', currentRoomId);
                    }
                });

                // ÏóêÎü¨ Ï≤òÎ¶¨
                socket.on('error', (data) => {
                    console.error('Socket ÏóêÎü¨:', data);
                    addMessage(data.message || 'Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'system');
                });
            } catch (error) {
                console.error('Socket Ïó∞Í≤∞ Ïã§Ìå®:', error);
                addMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.', 'system');
            }
        }

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(status) {
            const texts = translations[selectedLanguage] || translations['ko'];
            
            if (!statusDot || !statusText) return;
            
            switch(status) {
                case 'connected':
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'AI Ïó∞Í≤∞Îê®';
                    break;
                case 'connecting':
                    statusDot.className = 'status-dot connecting';
                    statusText.textContent = 'Ïó∞Í≤∞ Ï§ë...';
                    break;
                case 'staff_connected':
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'ÏßÅÏõê Ïó∞Í≤∞Îê®';
                    break;
                case 'disconnected':
                    statusDot.className = 'status-dot';
                    statusText.textContent = texts.connectionLost;
                    break;
            }
        }

        // Î™®Îìú ÏÑ§Ï†ï
        function setMode(mode) {
            currentMode = mode;
            
            const aiModeBtn = document.getElementById('aiMode');
            const staffModeBtn = document.getElementById('staffMode');
            
            if (aiModeBtn) {
                aiModeBtn.classList.toggle('active', mode === 'ai');
            }
            if (staffModeBtn) {
                staffModeBtn.classList.toggle('active', mode === 'staff');
            }
            
            if (mode === 'ai') {
                if (requestStaffButton) requestStaffButton.style.display = 'none';
                if (sendButton) sendButton.style.display = 'block';
                addMessage('AI Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§. ÏûêÎèôÏúºÎ°ú ÎãµÎ≥ÄÌï¥ÎìúÎ¶¥Í≤åÏöî! ü§ñ', 'system');
            } else {
                if (!isConnectedToStaff) {
                    addMessage('ÏßÅÏõê Ïó∞Í≤∞ Î™®ÎìúÏûÖÎãàÎã§. "ÏßÅÏõê Ïó∞Í≤∞" Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏßÅÏõêÍ≥º Ï±ÑÌåÖÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî. üë®‚Äçüíº', 'system');
                    if (requestStaffButton) requestStaffButton.style.display = 'block';
                    if (sendButton) sendButton.style.display = 'none';
                } else {
                    if (sendButton) sendButton.style.display = 'block';
                    if (requestStaffButton) requestStaffButton.style.display = 'none';
                }
            }
        }

        // üîß ÏàòÏ†ïÎêú ÏßÅÏõê Ïó∞Í≤∞ ÏöîÏ≤≠ Ìï®Ïàò
        function requestStaff() {
            if (isConnectedToStaff) return;
            
            if (!socket || !socket.connected) {
                console.error('Socket not connected');
                addMessage('Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.', 'system');
                return;
            }
            
            const texts = translations[selectedLanguage] || translations['ko'];
            
            try {
                // SocketÏúºÎ°ú ÏßÅÏõê Ïó∞Í≤∞ ÏöîÏ≤≠
                socket.emit('request_staff', {
                    room_number: roomNumber,
                    language: selectedLanguage
                });
                
                addMessage(texts.staffConnecting, 'system');
                
                if (requestStaffButton) {
                    requestStaffButton.style.display = 'none';
                }
                
                updateConnectionStatus('connecting');
            } catch (error) {
                console.error('ÏßÅÏõê Ïó∞Í≤∞ ÏöîÏ≤≠ Ïã§Ìå®:', error);
                addMessage('ÏßÅÏõê Ïó∞Í≤∞ ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'system');
            }
        }

        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        function addMessage(text, type, isTranslated = false) {
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'staff') {
                messageDiv.innerHTML = `
                    <div class="message-header">üë®‚Äçüíº ÏßÅÏõê</div>
                    <div>${text}</div>
                `;
            } else if (isTranslated && type === 'ai') {
                messageDiv.innerHTML = `
                    <div>${text}</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                        ü§ñ AI ÏûêÎèô ÏùëÎãµ
                    </div>
                `;
            } else {
                messageDiv.textContent = text;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Socket Î©îÏãúÏßÄ ÌëúÏãú
        function displayMessage(messageData) {
            const { sender_type, sender_name, original_message, translated_message } = messageData;
            
            if (sender_type === 'staff') {
                // ÏßÅÏõê Î©îÏãúÏßÄ: Î≤àÏó≠Îêú Î©îÏãúÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Î≤àÏó≠Îêú Í≤ÉÏùÑ, ÏóÜÏúºÎ©¥ ÏõêÎ≥∏ÏùÑ ÌëúÏãú
                const displayText = translated_message || original_message;
                addMessage(displayText, 'staff');
            } else if (sender_type === 'customer') {
                // Í≥†Í∞ù Î©îÏãúÏßÄ: ÏûêÏã†Ïù¥ Î≥¥ÎÇ∏ Î©îÏãúÏßÄÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå (Ïù¥ÎØ∏ ÌôîÎ©¥Ïóê ÏûàÏùå)
                return;
            }
        }

        // ÏßÅÏõê Ïó∞Í≤∞ ÌëúÏãú
        function addStaffIndicator() {
            if (!chatContainer) return;
            
            const indicator = document.createElement('div');
            indicator.className = 'staff-indicator';
            indicator.textContent = 'üë®‚Äçüíº ÏßÅÏõêÍ≥º Ïó∞Í≤∞Îê®';
            chatContainer.appendChild(indicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Îπ†Î•∏ Î©îÏãúÏßÄ ÏÇΩÏûÖ
        function insertQuickMessage(message) {
            if (messageInput) {
                messageInput.value = message;
                validateForm();
                messageInput.focus();
            }
        }

        // üîß ÏàòÏ†ïÎêú Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ìï®Ïàò
        function validateForm() {
            if (!messageInput || !sendButton) {
                return;
            }
            
            const isValid = messageInput.value.trim().length > 0;
            sendButton.disabled = !isValid;
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            if (!messageInput) return;
            
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
            addMessage(userMessage, 'user');
            
            // ÏûÖÎ†•Ï∞Ω ÎπÑÏö∞Í∏∞ Î∞è Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            messageInput.value = '';
            if (sendButton) sendButton.disabled = true;
            
            if (currentMode === 'ai') {
                // AI Î™®Îìú: Í∏∞Ï°¥ REST API ÏÇ¨Ïö©
                await handleAIResponse(userMessage);
            } else if (isConnectedToStaff && currentRoomId) {
                // ÏßÅÏõê Ï±ÑÌåÖ Î™®Îìú: Socket.IOÎ°ú Ïã§ÏãúÍ∞Ñ Ï†ÑÏÜ°
                console.log('ÏßÅÏõêÏóêÍ≤å Î©îÏãúÏßÄ Ï†ÑÏÜ°:', userMessage, 'Room ID:', currentRoomId);
                
                try {
                    socket.emit('send_message', {
                        room_id: currentRoomId,
                        message: userMessage,
                        sender_type: 'customer',
                        sender_name: 'Í≥†Í∞ù',
                        language: selectedLanguage
                    });
                } catch (error) {
                    console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                    addMessage('Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'system');
                }
            } else {
                addMessage('ÏßÅÏõêÍ≥º Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÏßÅÏõê Ïó∞Í≤∞ÏùÑ Î®ºÏ†Ä ÏöîÏ≤≠Ìï¥Ï£ºÏÑ∏Ïöî.', 'system');
            }
        }

        // AI ÏùëÎãµ Ï≤òÎ¶¨
        async function handleAIResponse(userMessage) {
            const texts = translations[selectedLanguage] || translations['ko'];
            
            // ÌÉÄÏù¥Ìïë ÌëúÏãú
            if (typingIndicator) {
                typingIndicator.textContent = texts.aiThinking;
                typingIndicator.classList.add('show');
            }

            try {
                // ÏÑúÎ≤ÑÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ° (Í∏∞Ï°¥ API ÏÇ¨Ïö©)
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        original_message: userMessage,
                        user_language: selectedLanguage,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();
                
                if (result.success && result.ai_response) {
                    // AI ÏùëÎãµ ÌëúÏãú
                    addMessage(result.ai_response, 'ai', true);
                    
                    // ÏßÅÏõê Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞
                    if (result.requires_staff) {
                        setTimeout(() => {
                            addMessage('Îçî ÏûêÏÑ∏Ìïú ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÏãúÎã§Î©¥ "ÏßÅÏõêÍ≥º Ï±ÑÌåÖ" Î™®ÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'system');
                        }, 1000);
                    }
                } else {
                    const errorMessages = {
                        'ko': "Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÌòÑÏû¨ ÏÑúÎπÑÏä§Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. ÏßÅÏõêÍ≥º Ï±ÑÌåÖÏùÑ ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.",
                        'en': "Sorry, there's an issue with the service. Please try staff chat.",
                        'ja': "Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÁèæÂú®„Çµ„Éº„Éì„Çπ„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Çπ„Çø„ÉÉ„Éï„ÉÅ„É£„ÉÉ„Éà„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                        'zh': "Êä±Ê≠âÔºåÊúçÂä°Âá∫Áé∞ÈóÆÈ¢ò„ÄÇËØ∑Â∞ùËØïÂëòÂ∑•ËÅäÂ§©„ÄÇ"
                    };
                    addMessage(errorMessages[selectedLanguage] || errorMessages['ko'], 'ai');
                }

            } catch (error) {
                console.error('Message sending failed:', error);
                const errorMessages = {
                    'ko': "Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.",
                    'en': "Failed to send message. Please try again.",
                    'ja': "„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    'zh': "Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•„ÄÇËØ∑ÈáçËØï„ÄÇ"
                };
                addMessage(errorMessages[selectedLanguage] || errorMessages['ko'], 'ai');
            } finally {
                if (typingIndicator) {
                    typingIndicator.classList.remove('show');
                }
            }
        }

        // Îí§Î°úÍ∞ÄÍ∏∞
        function goBack() {
            if (currentRoomId && socket) {
                try {
                    socket.emit('leave_room', { room_id: currentRoomId });
                } catch (error) {
                    console.log('Î∞© ÎÇòÍ∞ÄÍ∏∞ Ïã§Ìå®:', error);
                }
            }
            window.location.href = '/';
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        if (messageInput) {
            messageInput.addEventListener('input', validateForm);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (sendButton && !sendButton.disabled) {
                        sendMessage();
                    }
                }
            });
        }

        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
        });

        // ÌéòÏù¥ÏßÄÍ∞Ä Ïù¥ÎØ∏ Î°úÎìúÎêú Í≤ΩÏö∞Î•º ÏúÑÌïú Ï∂îÍ∞Ä Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>