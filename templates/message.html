<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì‹œì§€ ì‘ì„± - ë‚˜ì¸íŠ¸ë¦¬ í˜¸í…”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .room-info {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-details p {
            margin: 2px 0;
            font-size: 16px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-dot.connected {
            background-color: #4caf50;
        }

        .status-dot.connecting {
            background-color: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-mode-selector {
            padding: 15px 20px;
            background-color: #fff3cd;
            border-bottom: 1px solid #e1e1e1;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background-color: white;
            color: #333;
            border: 1px solid #e1e1e1;
        }

        .message.staff {
            background-color: #e8f5e8;
            color: #333;
            border: 1px solid #c8e6c9;
            border-left: 4px solid #4caf50;
        }

        .message.system {
            background-color: #e9ecef;
            color: #666;
            text-align: center;
            font-size: 14px;
            margin: 10px auto;
            max-width: 100%;
        }

        .message-header {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .message.staff .message-header {
            color: #2e7d32;
            font-weight: bold;
        }

        .staff-indicator {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        .message-input-container {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e1e1e1;
        }

        .message-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            min-width: 100px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-staff {
            background-color: #28a745;
            color: white;
            min-width: 120px;
        }

        .btn-staff:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #666;
            font-size: 14px;
            display: none;
        }

        .typing-indicator.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .quick-action {
            background-color: #f8f9fa;
            border: 1px solid #e1e1e1;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background-color: #e9ecef;
            border-color: #667eea;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }

            .room-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .mode-buttons {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }

            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ ë‚˜ì¸íŠ¸ë¦¬ í˜¸í…”</h1>
            <p>AI ë©”ì‹œì§€ ì»¨ì‹œì–´ì§€</p>
        </div>

        <div class="room-info">
            <div class="room-details">
                <p id="roomInfo"><strong>ê°ì‹¤:</strong> <span id="roomNumber">-</span></p>
                <p id="languageInfo"><strong>ì–¸ì–´:</strong> <span id="selectedLanguage">-</span></p>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ì—°ê²° ì¤‘...</span>
            </div>
        </div>

        <div class="chat-mode-selector" id="chatModeSelector">
            <p><strong>ğŸ’¡ ì„œë¹„ìŠ¤ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</strong></p>
            <div class="mode-buttons">
                <button class="mode-btn active" id="aiMode" onclick="setMode('ai')">
                    ğŸ¤– AI ìë™ ì‘ë‹µ
                </button>
                <button class="mode-btn" id="staffMode" onclick="setMode('staff')">
                    ğŸ‘¨â€ğŸ’¼ ì§ì›ê³¼ ì±„íŒ…
                </button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message system">
                ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ¤–<br>
                <small>ê°„ë‹¨í•œ ì§ˆë¬¸ì€ AIê°€, ë³µì¡í•œ ë¬¸ì˜ëŠ” ì§ì›ì´ ë„ì›€ë“œë¦½ë‹ˆë‹¤.</small>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
        </div>

        <div class="loading" id="loadingIndicator">
            ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <div class="message-input-container">
            <div class="quick-actions">
                <button class="quick-action" onclick="insertQuickMessage('WiFi ë¹„ë°€ë²ˆí˜¸ê°€ ë­”ê°€ìš”?')">WiFi ë¹„ë°€ë²ˆí˜¸</button>
                <button class="quick-action" onclick="insertQuickMessage('ì²´í¬ì•„ì›ƒ ì‹œê°„ì´ ì–¸ì œì¸ê°€ìš”?')">ì²´í¬ì•„ì›ƒ ì‹œê°„</button>
                <button class="quick-action" onclick="insertQuickMessage('ì¡°ì‹ì€ ëª‡ ì‹œë¶€í„°ì¸ê°€ìš”?')">ì¡°ì‹ ì‹œê°„</button>
                <button class="quick-action" onclick="insertQuickMessage('ìˆ˜ì˜ì¥ ì´ìš© ì‹œê°„ì„ ì•Œê³  ì‹¶ì–´ìš”')">ìˆ˜ì˜ì¥ ì‹œê°„</button>
                <button class="quick-action" onclick="insertQuickMessage('ì£¼ì°¨ì¥ì€ ì–´ë””ì— ìˆë‚˜ìš”?')">ì£¼ì°¨ì¥ ìœ„ì¹˜</button>
                <button class="quick-action" onclick="insertQuickMessage('íƒ€ì˜¬ì„ ë” ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?')">íƒ€ì˜¬ ìš”ì²­</button>
            </div>

            <textarea 
                id="messageInput" 
                class="message-input" 
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                rows="3"
            ></textarea>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    ë’¤ë¡œê°€ê¸°
                </button>
                <button type="button" class="btn btn-primary" id="sendButton" disabled>
                    ë©”ì‹œì§€ ì „ì†¡
                </button>
                <button type="button" class="btn btn-staff" id="requestStaffButton" onclick="requestStaff()" style="display: none;">
                    ì§ì› ì—°ê²°
                </button>
            </div>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room');
        const selectedLanguage = urlParams.get('lang');

        // ì „ì—­ ë³€ìˆ˜
        let socket;
        let currentMode = 'ai'; // 'ai' ë˜ëŠ” 'staff'
        let currentRoomId = null;
        let isConnectedToStaff = false;

        // DOM ìš”ì†Œ
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatContainer = document.getElementById('chatContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const typingIndicator = document.getElementById('typingIndicator');
        const requestStaffButton = document.getElementById('requestStaffButton');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // ì–¸ì–´ í‘œì‹œ í…ìŠ¤íŠ¸
        const languageNames = {
            'ko': 'í•œêµ­ì–´ ğŸ‡°ğŸ‡·',
            'en': 'English ğŸ‡ºğŸ‡¸',
            'ja': 'æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ',
            'zh': 'ä¸­æ–‡ ğŸ‡¨ğŸ‡³'
        };

        // ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸
        const translations = {
            'ko': {
                messagePlaceholder: 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
                backButton: 'ë’¤ë¡œê°€ê¸°',
                sendButton: 'ë©”ì‹œì§€ ì „ì†¡',
                staffButton: 'ì§ì› ì—°ê²°',
                aiThinking: 'AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                staffConnecting: 'ì§ì› ì—°ê²°ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤...',
                staffConnected: 'ì§ì›ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!',
                connectionLost: 'ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...'
            },
            'en': {
                messagePlaceholder: 'Enter your message...',
                backButton: 'Back',
                sendButton: 'Send Message',
                staffButton: 'Connect Staff',
                aiThinking: 'AI is generating response...',
                staffConnecting: 'Requesting staff connection...',
                staffConnected: 'Connected to staff!',
                connectionLost: 'Connection lost. Reconnecting...'
            },
            'ja': {
                messagePlaceholder: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
                backButton: 'æˆ»ã‚‹',
                sendButton: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡',
                staffButton: 'ã‚¹ã‚¿ãƒƒãƒ•æ¥ç¶š',
                aiThinking: 'AIãŒè¿”ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...',
                staffConnecting: 'ã‚¹ã‚¿ãƒƒãƒ•æ¥ç¶šã‚’è¦æ±‚ã—ã¾ã—ãŸ...',
                staffConnected: 'ã‚¹ã‚¿ãƒƒãƒ•ã¨æ¥ç¶šã•ã‚Œã¾ã—ãŸï¼',
                connectionLost: 'æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šä¸­...'
            },
            'zh': {
                messagePlaceholder: 'è¯·è¾“å…¥ä¿¡æ¯...',
                backButton: 'è¿”å›',
                sendButton: 'å‘é€ä¿¡æ¯',
                staffButton: 'è¿æ¥å‘˜å·¥',
                aiThinking: 'AIæ­£åœ¨ç”Ÿæˆå›å¤...',
                staffConnecting: 'å·²è¯·æ±‚å‘˜å·¥è¿æ¥...',
                staffConnected: 'å·²ä¸å‘˜å·¥è¿æ¥ï¼',
                connectionLost: 'è¿æ¥æ–­å¼€ã€‚é‡æ–°è¿æ¥ä¸­...'
            }
        };

        // í˜ì´ì§€ ì´ˆê¸°í™”
        function initializePage() {
            // í•„ìˆ˜ ìš”ì†Œ ì¡´ì¬ í™•ì¸
            const roomNumberElement = document.getElementById('roomNumber');
            const selectedLanguageElement = document.getElementById('selectedLanguage');
            
            if (!roomNumberElement || !selectedLanguageElement) {
                console.error('Required HTML elements not found');
                return;
            }
            
            roomNumberElement.textContent = roomNumber || '?';
            selectedLanguageElement.textContent = languageNames[selectedLanguage] || 'Unknown';
            
            // ì–¸ì–´ë³„ UI í…ìŠ¤íŠ¸ ì ìš©
            const texts = translations[selectedLanguage] || translations['ko'];

            // ê¸°ë³¸ UI ìš”ì†Œë“¤ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            if (messageInput) {
                messageInput.placeholder = texts.messagePlaceholder;
            }
            if (sendButton) {
                sendButton.textContent = texts.sendButton;
            }
            if (requestStaffButton) {
                requestStaffButton.textContent = texts.staffButton;
            }
            
            const backBtn = document.querySelector('.btn-secondary');
            if (backBtn) {
                backBtn.textContent = texts.backButton;
            }

            // ëª¨ë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updateModeButtonTexts();

            // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ ì–¸ì–´ë³„ ì—…ë°ì´íŠ¸
            updateQuickActionButtons();

            // Socket.IO ì—°ê²°
            connectSocket();
        }

        // ğŸ”§ ìˆ˜ì •ëœ ëª¨ë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateModeButtonTexts() {
            const modeTexts = {
                'ko': {
                    aiMode: 'ğŸ¤– AI ìë™ ì‘ë‹µ',
                    staffMode: 'ğŸ‘¨â€ğŸ’¼ ì§ì›ê³¼ ì±„íŒ…'
                },
                'en': {
                    aiMode: 'ğŸ¤– AI Auto Response',
                    staffMode: 'ğŸ‘¨â€ğŸ’¼ Chat with Staff'
                },
                'ja': {
                    aiMode: 'ğŸ¤– AIè‡ªå‹•å¿œç­”',
                    staffMode: 'ğŸ‘¨â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•ã¨ãƒãƒ£ãƒƒãƒˆ'
                },
                'zh': {
                    aiMode: 'ğŸ¤– AIè‡ªåŠ¨å›å¤',
                    staffMode: 'ğŸ‘¨â€ğŸ’¼ ä¸å‘˜å·¥èŠå¤©'
                }
            };
            
            const currentTexts = modeTexts[selectedLanguage] || modeTexts['ko'];
            
            // ğŸ”§ ì•ˆì „í•œ ìš”ì†Œ ì ‘ê·¼ (ì˜¤íƒ€ ìˆ˜ì •: aimode â†’ aiMode)
            const aiModeBtn = document.getElementById('aiMode');
            const staffModeBtn = document.getElementById('staffMode');
            
            if (aiModeBtn) {
                aiModeBtn.innerHTML = currentTexts.aiMode;
            }
            if (staffModeBtn) {
                staffModeBtn.innerHTML = currentTexts.staffMode;
            }
        }

        // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateQuickActionButtons() {
            const quickActions = {
                'ko': [
                    'WiFi ë¹„ë°€ë²ˆí˜¸ê°€ ë­”ê°€ìš”?',
                    'ì²´í¬ì•„ì›ƒ ì‹œê°„ì´ ì–¸ì œì¸ê°€ìš”?',
                    'ì¡°ì‹ì€ ëª‡ ì‹œë¶€í„°ì¸ê°€ìš”?',
                    'ìˆ˜ì˜ì¥ ì´ìš© ì‹œê°„ì„ ì•Œê³  ì‹¶ì–´ìš”',
                    'ì£¼ì°¨ì¥ì€ ì–´ë””ì— ìˆë‚˜ìš”?',
                    'íƒ€ì˜¬ì„ ë” ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?'
                ],
                'en': [
                    'What is the WiFi password?',
                    'What time is check-out?',
                    'What time is breakfast?',
                    'What are the pool hours?',
                    'Where is the parking?',
                    'Can I get more towels?'
                ],
                'ja': [
                    'WiFiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹ï¼Ÿ',
                    'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚é–“ã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ',
                    'æœé£Ÿã¯ä½•æ™‚ã‹ã‚‰ã§ã™ã‹ï¼Ÿ',
                    'ãƒ—ãƒ¼ãƒ«ã®åˆ©ç”¨æ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„',
                    'é§è»Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ',
                    'ã‚¿ã‚ªãƒ«ã‚’ã‚‚ã£ã¨ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ'
                ],
                'zh': [
                    'WiFiå¯†ç æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'é€€æˆ¿æ—¶é—´æ˜¯å‡ ç‚¹ï¼Ÿ',
                    'æ—©é¤å‡ ç‚¹å¼€å§‹ï¼Ÿ',
                    'æ¸¸æ³³æ± å¼€æ”¾æ—¶é—´ï¼Ÿ',
                    'åœè½¦åœºåœ¨å“ªé‡Œï¼Ÿ',
                    'å¯ä»¥å†ç»™ä¸€äº›æ¯›å·¾å—ï¼Ÿ'
                ]
            };
            
            const actions = quickActions[selectedLanguage] || quickActions['ko'];
            const quickActionElements = document.querySelectorAll('.quick-action');

            quickActionElements.forEach((element, index) => {
                if (actions[index]) {
                    element.textContent = actions[index];
                    element.onclick = () => insertQuickMessage(actions[index]);
                }
            });
        }

        // Socket.IO ì—°ê²°
        function connectSocket() {
            try {
                socket = io();

                socket.on('connect', () => {
                    console.log('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    updateConnectionStatus('connected');
                });

                socket.on('disconnect', () => {
                    console.log('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
                    updateConnectionStatus('disconnected');
                });

                // ë©”ì‹œì§€ ìˆ˜ì‹ 
                socket.on('receive_message', (data) => {
                    console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
                    displayMessage(data);
                });

                // ì§ì› ì°¸ì—¬ ì•Œë¦¼
                socket.on('staff_joined', (data) => {
                    console.log('ì§ì› ì°¸ì—¬:', data);
                    isConnectedToStaff = true;
                    addMessage(data.message, 'system');
                    addStaffIndicator();
                    updateConnectionStatus('staff_connected');
                });

                // ì‹œìŠ¤í…œ ë©”ì‹œì§€
                socket.on('system_message', (data) => {
                    addMessage(data.message, 'system');
                    
                    // room_idê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì €ì¥
                    if (data.room_id) {
                        currentRoomId = data.room_id;
                        console.log('ì±„íŒ…ë°© ID ì„¤ì •:', currentRoomId);
                    }
                });

                // ì—ëŸ¬ ì²˜ë¦¬
                socket.on('error', (data) => {
                    console.error('Socket ì—ëŸ¬:', data);
                    addMessage(data.message || 'ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'system');
                });
            } catch (error) {
                console.error('Socket ì—°ê²° ì‹¤íŒ¨:', error);
                addMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'system');
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status) {
            const texts = translations[selectedLanguage] || translations['ko'];
            
            if (!statusDot || !statusText) return;
            
            switch(status) {
                case 'connected':
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'AI ì—°ê²°ë¨';
                    break;
                case 'connecting':
                    statusDot.className = 'status-dot connecting';
                    statusText.textContent = 'ì—°ê²° ì¤‘...';
                    break;
                case 'staff_connected':
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'ì§ì› ì—°ê²°ë¨';
                    break;
                case 'disconnected':
                    statusDot.className = 'status-dot';
                    statusText.textContent = texts.connectionLost;
                    break;
            }
        }

        // ëª¨ë“œ ì„¤ì •
        function setMode(mode) {
            currentMode = mode;
            
            const aiModeBtn = document.getElementById('aiMode');
            const staffModeBtn = document.getElementById('staffMode');
            
            if (aiModeBtn) {
                aiModeBtn.classList.toggle('active', mode === 'ai');
            }
            if (staffModeBtn) {
                staffModeBtn.classList.toggle('active', mode === 'staff');
            }
            
            if (mode === 'ai') {
                if (requestStaffButton) requestStaffButton.style.display = 'none';
                if (sendButton) sendButton.style.display = 'block';
                addMessage('AI ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë‹µë³€í•´ë“œë¦´ê²Œìš”! ğŸ¤–', 'system');
            } else {
                if (!isConnectedToStaff) {
                    addMessage('ì§ì› ì—°ê²° ëª¨ë“œì…ë‹ˆë‹¤. "ì§ì› ì—°ê²°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§ì›ê³¼ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”. ğŸ‘¨â€ğŸ’¼', 'system');
                    if (requestStaffButton) requestStaffButton.style.display = 'block';
                    if (sendButton) sendButton.style.display = 'none';
                } else {
                    if (sendButton) sendButton.style.display = 'block';
                    if (requestStaffButton) requestStaffButton.style.display = 'none';
                }
            }
        }

        // ğŸ”§ ìˆ˜ì •ëœ ì§ì› ì—°ê²° ìš”ì²­ í•¨ìˆ˜
        function requestStaff() {
            if (isConnectedToStaff) return;
            
            if (!socket || !socket.connected) {
                console.error('Socket not connected');
                addMessage('ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'system');
                return;
            }
            
            const texts = translations[selectedLanguage] || translations['ko'];
            
            try {
                // Socketìœ¼ë¡œ ì§ì› ì—°ê²° ìš”ì²­
                socket.emit('request_staff', {
                    room_number: roomNumber,
                    language: selectedLanguage
                });
                
                addMessage(texts.staffConnecting, 'system');
                
                if (requestStaffButton) {
                    requestStaffButton.style.display = 'none';
                }
                
                updateConnectionStatus('connecting');
            } catch (error) {
                console.error('ì§ì› ì—°ê²° ìš”ì²­ ì‹¤íŒ¨:', error);
                addMessage('ì§ì› ì—°ê²° ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'system');
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, type, isTranslated = false) {
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'staff') {
                messageDiv.innerHTML = `
                    <div class="message-header">ğŸ‘¨â€ğŸ’¼ ì§ì›</div>
                    <div>${text}</div>
                `;
            } else if (isTranslated && type === 'ai') {
                messageDiv.innerHTML = `
                    <div>${text}</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                        ğŸ¤– AI ìë™ ì‘ë‹µ
                    </div>
                `;
            } else {
                messageDiv.textContent = text;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Socket ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(messageData) {
            const { sender_type, sender_name, original_message, translated_message } = messageData;
            
            if (sender_type === 'staff') {
                // ì§ì› ë©”ì‹œì§€: ë²ˆì—­ëœ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ë²ˆì—­ëœ ê²ƒì„, ì—†ìœ¼ë©´ ì›ë³¸ì„ í‘œì‹œ
                const displayText = translated_message || original_message;
                addMessage(displayText, 'staff');
            } else if (sender_type === 'customer') {
                // ê³ ê° ë©”ì‹œì§€: ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì´ë¯¸ í™”ë©´ì— ìˆìŒ)
                return;
            }
        }

        // ì§ì› ì—°ê²° í‘œì‹œ
        function addStaffIndicator() {
            if (!chatContainer) return;
            
            const indicator = document.createElement('div');
            indicator.className = 'staff-indicator';
            indicator.textContent = 'ğŸ‘¨â€ğŸ’¼ ì§ì›ê³¼ ì—°ê²°ë¨';
            chatContainer.appendChild(indicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ë¹ ë¥¸ ë©”ì‹œì§€ ì‚½ì…
        function insertQuickMessage(message) {
            if (messageInput) {
                messageInput.value = message;
                validateForm();
                messageInput.focus();
            }
        }

        // ğŸ”§ ìˆ˜ì •ëœ í¼ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function validateForm() {
            if (!messageInput || !sendButton) {
                return;
            }
            
            const isValid = messageInput.value.trim().length > 0;
            sendButton.disabled = !isValid;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            if (!messageInput) return;
            
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage(userMessage, 'user');
            
            // ì…ë ¥ì°½ ë¹„ìš°ê¸° ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            messageInput.value = '';
            if (sendButton) sendButton.disabled = true;
            
            if (currentMode === 'ai') {
                // AI ëª¨ë“œ: ê¸°ì¡´ REST API ì‚¬ìš©
                await handleAIResponse(userMessage);
            } else if (isConnectedToStaff && currentRoomId) {
                // ì§ì› ì±„íŒ… ëª¨ë“œ: Socket.IOë¡œ ì‹¤ì‹œê°„ ì „ì†¡
                console.log('ì§ì›ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡:', userMessage, 'Room ID:', currentRoomId);
                
                try {
                    socket.emit('send_message', {
                        room_id: currentRoomId,
                        message: userMessage,
                        sender_type: 'customer',
                        sender_name: 'ê³ ê°',
                        language: selectedLanguage
                    });
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                    addMessage('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'system');
                }
            } else {
                addMessage('ì§ì›ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§ì› ì—°ê²°ì„ ë¨¼ì € ìš”ì²­í•´ì£¼ì„¸ìš”.', 'system');
            }
        }

        // AI ì‘ë‹µ ì²˜ë¦¬
        async function handleAIResponse(userMessage) {
            const texts = translations[selectedLanguage] || translations['ko'];
            
            // íƒ€ì´í•‘ í‘œì‹œ
            if (typingIndicator) {
                typingIndicator.textContent = texts.aiThinking;
                typingIndicator.classList.add('show');
            }

            try {
                // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ (ê¸°ì¡´ API ì‚¬ìš©)
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        original_message: userMessage,
                        user_language: selectedLanguage,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();
                
                if (result.success && result.ai_response) {
                    // AI ì‘ë‹µ í‘œì‹œ
                    addMessage(result.ai_response, 'ai', true);
                    
                    // ì§ì› ì—°ê²°ì´ í•„ìš”í•œ ê²½ìš°
                    if (result.requires_staff) {
                        setTimeout(() => {
                            addMessage('ë” ìì„¸í•œ ë„ì›€ì´ í•„ìš”í•˜ì‹œë‹¤ë©´ "ì§ì›ê³¼ ì±„íŒ…" ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'system');
                        }, 1000);
                    }
                } else {
                    const errorMessages = {
                        'ko': "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì§ì›ê³¼ ì±„íŒ…ì„ ì‹œë„í•´ë³´ì„¸ìš”.",
                        'en': "Sorry, there's an issue with the service. Please try staff chat.",
                        'ja': "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨ã‚µãƒ¼ãƒ“ã‚¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ãƒãƒ£ãƒƒãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚",
                        'zh': "æŠ±æ­‰ï¼ŒæœåŠ¡å‡ºç°é—®é¢˜ã€‚è¯·å°è¯•å‘˜å·¥èŠå¤©ã€‚"
                    };
                    addMessage(errorMessages[selectedLanguage] || errorMessages['ko'], 'ai');
                }

            } catch (error) {
                console.error('Message sending failed:', error);
                const errorMessages = {
                    'ko': "ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
                    'en': "Failed to send message. Please try again.",
                    'ja': "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
                    'zh': "æ¶ˆæ¯å‘é€å¤±è´¥ã€‚è¯·é‡è¯•ã€‚"
                };
                addMessage(errorMessages[selectedLanguage] || errorMessages['ko'], 'ai');
            } finally {
                if (typingIndicator) {
                    typingIndicator.classList.remove('show');
                }
            }
        }

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            if (currentRoomId && socket) {
                try {
                    socket.emit('leave_room', { room_id: currentRoomId });
                } catch (error) {
                    console.log('ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨:', error);
                }
            }
            window.location.href = '/';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (messageInput) {
            messageInput.addEventListener('input', validateForm);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (sendButton && !sendButton.disabled) {
                        sendMessage();
                    }
                }
            });
        }

        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
        });

        // í˜ì´ì§€ê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ë¥¼ ìœ„í•œ ì¶”ê°€ ì´ˆê¸°í™”
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>